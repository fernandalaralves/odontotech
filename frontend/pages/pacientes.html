<!-- ============================================ -->
<!-- frontend/pages/pacientes.html -->
<!-- ============================================ -->
<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pacientes - Sistema Odontológico</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../assets/css/styles.css" />
  </head>
  <body>
    <div id="navbar"></div>

    <div class="container-fluid">
      <div class="row">
        <div
          id="sidebar"
          class="col-md-2 bg-dark text-white min-vh-100 p-0"
        ></div>

        <main class="col-md-10 p-4">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Gestão de Pacientes</h2>
            <button class="btn btn-primary" onclick="abrirModalNovo()">
              Novo Paciente
            </button>
          </div>

          <div class="card mb-4">
            <div class="card-body">
              <div class="input-group">
                <input
                  type="text"
                  class="form-control"
                  id="campoBusca"
                  placeholder="Buscar por nome, CPF ou telefone"
                />
                <button
                  class="btn btn-outline-secondary"
                  onclick="buscarPacientes()"
                >
                  Buscar
                </button>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <table class="table table-hover" id="tabelaPacientes">
                <thead>
                  <tr>
                    <th>Nome</th>
                    <th>CPF</th>
                    <th>Telefone</th>
                    <th>Email</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </main>
      </div>
    </div>

    <div class="modal fade" id="modalPaciente" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitulo">Novo Paciente</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-12">
                <label class="form-label">Nome Completo</label>
                <input type="text" class="form-control" id="nome" />
              </div>

              <div class="col-md-6">
                <label class="form-label">CPF</label>
                <input
                  type="text"
                  class="form-control"
                  id="cpf"
                  placeholder="000.000.000-00"
                />
              </div>

              <div class="col-md-6">
                <label class="form-label">Data de Nascimento</label>
                <input type="date" class="form-control" id="data_nascimento" />
              </div>

              <div class="col-md-6">
                <label class="form-label">Telefone</label>
                <input
                  type="text"
                  class="form-control"
                  id="telefone"
                  placeholder="(00) 00000-0000"
                />
              </div>

              <div class="col-md-6">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" id="email" />
              </div>

              <div class="col-md-12">
                <label class="form-label">Endereço</label>
                <input type="text" class="form-control" id="endereco" />
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="salvarPaciente()"
            >
              Salvar
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="../services/api.js"></script>
    <script src="../services/authService.js"></script>
    <script src="../components/navbar.js"></script>
    <script src="../components/sidebar.js"></script>
    <script>
      let pacienteEditando = null;
      let modal;

      document.addEventListener("DOMContentLoaded", async function () {
        if (!AuthService.verificarAutenticacao()) {
          window.location.href = "../index.html";
          return;
        }

        carregarComponentes();
        await carregarPacientes();

        modal = new bootstrap.Modal(document.getElementById("modalPaciente"));
      });

      function carregarComponentes() {
        document.getElementById("navbar").innerHTML = Navbar.render();
        document.getElementById("sidebar").innerHTML =
          Sidebar.render("pacientes");
      }

      async function carregarPacientes() {
        try {
          const response = await API.get("/pacientes");
          preencherTabela(response.data);
        } catch (error) {
          alert("Erro ao carregar pacientes");
        }
      }

      function preencherTabela(pacientes) {
        const tbody = document.querySelector("#tabelaPacientes tbody");
        tbody.innerHTML = "";

        pacientes.forEach((paciente) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
          <td>${paciente.nome}</td>
          <td>${paciente.cpf}</td>
          <td>${paciente.telefone}</td>
          <td>${paciente.email || "-"}</td>
          <td>
            <button class="btn btn-sm btn-warning" onclick="editarPaciente(${
              paciente.id
            })">Editar</button>
            <button class="btn btn-sm btn-danger" onclick="excluirPaciente(${
              paciente.id
            })">Excluir</button>
          </td>
        `;
          tbody.appendChild(tr);
        });
      }

      function abrirModalNovo() {
        pacienteEditando = null;
        document.getElementById("modalTitulo").textContent = "Novo Paciente";
        limparFormulario();
        modal.show();
      }

      async function editarPaciente(id) {
        try {
          const response = await API.get(`/pacientes/${id}`);
          pacienteEditando = response.data;

          document.getElementById("modalTitulo").textContent =
            "Editar Paciente";
          document.getElementById("nome").value = pacienteEditando.nome;
          document.getElementById("cpf").value = pacienteEditando.cpf;
          document.getElementById("data_nascimento").value =
            pacienteEditando.data_nascimento;
          document.getElementById("telefone").value = pacienteEditando.telefone;
          document.getElementById("email").value = pacienteEditando.email || "";
          document.getElementById("endereco").value =
            pacienteEditando.endereco || "";

          modal.show();
        } catch (error) {
          alert("Erro ao carregar dados do paciente");
        }
      }

      async function salvarPaciente() {
        const dados = {
          nome: document.getElementById("nome").value,
          cpf: document.getElementById("cpf").value,
          data_nascimento: document.getElementById("data_nascimento").value,
          telefone: document.getElementById("telefone").value,
          email: document.getElementById("email").value,
          endereco: document.getElementById("endereco").value,
        };

        try {
          if (pacienteEditando) {
            await API.put(`/pacientes/${pacienteEditando.id}`, dados);
            alert("Paciente atualizado com sucesso!");
          } else {
            await API.post("/pacientes", dados);
            alert("Paciente cadastrado com sucesso!");
          }

          modal.hide();
          await carregarPacientes();
          limparFormulario();
        } catch (error) {
          alert(error.message || "Erro ao salvar paciente");
        }
      }

      async function excluirPaciente(id) {
        if (!confirm("Tem certeza que deseja excluir este paciente?")) return;

        try {
          await API.delete(`/pacientes/${id}`);
          alert("Paciente excluído com sucesso!");
          await carregarPacientes();
        } catch (error) {
          alert("Erro ao excluir paciente");
        }
      }

      function limparFormulario() {
        document.getElementById("nome").value = "";
        document.getElementById("cpf").value = "";
        document.getElementById("data_nascimento").value = "";
        document.getElementById("telefone").value = "";
        document.getElementById("email").value = "";
        document.getElementById("endereco").value = "";
      }

      async function buscarPacientes() {
        const termo = document.getElementById("campoBusca").value;

        try {
          const response = await API.get(`/pacientes/search?q=${termo}`);
          preencherTabela(response.data);
        } catch (error) {
          alert("Erro ao buscar pacientes");
        }
      }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
